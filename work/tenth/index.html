<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>

$(function() {
// ーーーーーーーーーーーーーーーーーーーーーー変数定義ーーーーーーーーーーーーーーーーーーーーーーーーー
  var pages = 1;
  var lastpage = false;
// ーーーーーーーーーーーーーーーーーーーーーークリックイベントーーーーーーーーーーーーーーーーーーーーーーーーー
  $('.search').after('<div class="message">'+'</div>');
  $(document).on('click', '#js-search-button', function() {
    pages = 1;
    $('.lists').children().remove();
    fetch(); //（フェッチ）取得、読み込み
  });
  $(document).on('click', '.prev', function() {
    if(pages === 1){
      return false;
    } else {
      pages--;
      fetch();
    }
  });
  $(document).on('click', '.next', function() {
    if (lastpage) {
      $('.message').empty();
      $('.message').append('これ以上ありません。');
    } else {
      pages++;
      fetch();
    }
  });
// searchの下に追加する。
// js-search-buttonをクリックした時に、
// pageが1ページから表示させる。
// listsの子要素を削除する。
// fetch();関数を実行してます。
// ーーーーーーーーーーーーーーーーーーーーーーajaxーーーーーーーーーーーーーーーーーーーーーーーーーーー
  function fetch() {
    var keyword = $('#js-search-word').val();
    $.ajax({
      url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',　//リクエストURL
      type: 'GET',　//HTTPのリクエストメソッド（POST/GET）を指定する
      datatype: 'json',　//JSONデータを受信する場合
// ーーーーーーーーーーーーーーーーーーjsonーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
      //jsonはJavaScriptのデータフォーマット（特定の形式に当てはめられたデータの集まりのこと）でオブジェクト、配列、数値、文字列、真偽値、など、誰が書いても分かるようにすることや、機械が判別できるようにしたデータ構造のこと。
// ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
      data: {
        applicationId: '1019399324990976605',　//アプリID
        booksGenreId: '001',　//楽天市場におけるジャンルを特定するためのID検索キーワード、ジャンルID、商品コード、ショップコードのいずれかが指定されていることが必須です。
        keyword: keyword,　// 検索のキーワードのこと
        hits: 20,　// 1ページあたりの取得件数
        page:pages　// page:2だと2ページを表示される
      },
    })
    // fetch()関数を定義してます
    // $('#js-search-word').val();を変数、keywordに定義した

// ーーーーーーーーーーーーーーーーーーーーーーdoneーーーーーーーーーーーーーーーーーーーーーーーーー
  .done(function(data) {
    booklistDisplay(data);
})
  .fail(function(error) {
    errorMessage(error);
  }); // end totaldata
  };
// -------------------------------------作品データ--------------------------------
function booklistDisplay(data) {
  $('.message').empty();
  $('.js-pager').remove();
  if(data.count === 0) {
    $('.list').empty(); //<ul class="lists"></ul>子要素（var list）のこと
    $('.message').append('検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。');
  } else {
    $('.lists__item').remove();
    var list ='';
    $(data.Items).each(function(index, value) {//index 数 value 内容
      list += '<li class="lists__item">'+
                '<div class="lists__item__inner">'+
                  '<a href='+value.Item.itemUrl+' class="lists__item__link" target="_blank">'+
                  '<img src='+value.Item.largeImageUrl+' class="lists__item__img" alt="">'+
                  '<p class="lists__item__detail">作品名：'+value.Item.title+'</p>'+
                  '<p class="lists__item__detail">作者：'+value.Item.author+'</p>'+
                  '<p class="lists__item__detail">出版社：'+value.Item.publisherName+'</p>'+
                '</a>'+
                '</div>'+
              '</li>';
      });
    $('.lists').append(list);
  };
  //  検索の結果をbooklistDisplay関数で引数(data)を定義した
  // .messageのclassの子要素を削除した。
  //  .js-pagerのclassを削除した。
// if文でdata.countが0の時listの子要素を削除する。
// apppendでmessageclassの後ろに追加する。
// elseでそれ以外は.lists__itemを削除する。
// 変数list空の文字列を代入する
// data.Itemsをecho文で繰り返し作品の情報の取得の処理を行う。
// 関数をつけfunction引数(index, value)を定義する。
// 変数listに作品の情報を代入する
// appendでlistsclassに変数listを追加する。
// -------------------------------------ページャクリックイベント--------------------------------
  $('ul').after(
    '<div class="js-pager">'+
      '<ul class="btn-wrapper">'+
        '<li class="prev btn-item">'+'<a class="btn-anchor" href="#">前へ</a></li>'+
        '<li class="next btn-item">'+'<a class="btn-anchor" href="#">次へ</a></li>'+
      '</ul>'+
    '</div>');
  if (pages === data.pageCount) {
    $('.next').addClass('disabled');
    lastpage = true;
  } else {
    lastpage = false;
  }
  if (pages === 1) {
    $('.prev').addClass('disabled');
  }
};
// afterでulの後ろにつける。
// if文でpagesがdata.pageCounと同じ時.next（次へボタン）のclassにdisabledを追加する。
// pagesがdata.pageCounと同じ時、lastpage = true;である
//elseでそれ以外はlastpage = false;である
// if文でpages === 1の時.prev（前へ）ボタンのclassにdisabledを追加する。
// -------------------------------------エラー文---------------------------------------------
  function errorMessage(error) {
    $('.message').empty();
    var errorText = '';
    switch (error.status) {
      case 400:
        errorText = '検索文字が空、もしくは半角英数1文字になっています。';
        break;
      case 0:
        errorText = '通信に失敗しました。インターネットの接続をご確認ください。';
        break;
      case 429:
        errorText = '連打はやめましょう。';
        break;
      case 500:
        errorText = 'システムエラー。長時間続くようであれば、こちらよりごお問い合わせください。';
        break;
      case 503:
        errorText = 'メンテナンス (楽天API)';
        break;
      default:
        errorText = '予期せぬエラーが発生しました。';
    }
    $('.message').append(errorText);
  };
});
// 関数errorMessageを定義しerrorMessageの引数(error)を定義します。
// message classの子要素を削除する。
// 変数var errorCodeにerror.statusを代入する。
// 変数var errorTextに空の文字列を代入する。
// switch文でcase 400の時、errorText が'検索文字が空、もしくは半角英数1文字になっています。';になる
// appendでdomの中の後につける。
    </script>
  </body>
</html>
<!-- // 楽天ブックスの総合検索APIを使って製作してください。
// // answerの挙動を良く見てね！
// //
// // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
// // https://webservice.rakuten.co.jp/api/bookstotalsearch/
// //
// //
// // [使うメソッド]
// // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
// // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
// // 以下は今回使う$.ajaxの基本的な形です。
// //
// // $.ajax({
// //   url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
// //   type: 'GET',
// //   datatype: 'json',
// //   data: {
// //     // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
// //     applicationId: '1019399324990976605', // (今回はこのIDを使用してください) ※IDは他サイト等には絶対に転載しないでください
// //     booksGenreId: '001'
// //   },
// // }).done(function(data) {
// //   // この中にデータ取得後の動きを記述していきます。
// // });
// //
// //
// // $.ajaxによってデータが取得できたら、必要なデータ(作品名とか作者名とか)を取得します。
// // 取得できたらHTMLに<ul class='lists'></ul>を用意しているので、下のテンプレに沿ってデータを入れ込みましょう。
// // <li class='lists__item'>
// //  <div class='lists__item__inner'>
// //    <a href='' class='lists__item__link' target='_blank'>
// //      <img src='' class='lists__item__img' alt=''>
// //      <p class='lists__item__detail'>作品名：</p>
// //      <p class='lists__item__detail'>作者　：</p>
// //      <p class='lists__item__detail'>出版社：</p>
// //    </a>
// //  </div>
// // </li>
// //
// // 取得できた書籍の件数をもとに、ページャを作成しましょう
// // ページャの条件
// // ├ 「前へ」と「次へ」のボタンがある
// // ├ 1ページ目では「前へ」に、最後のページでは「次へ」にdisabledクラスをつけて非活性（使用不能）にする
// // └ 1ページしかない場合はどちらもdisabledクラスをつけて非活性にする
// //
// // ページャのテンプレート
// // <div class="js-pager">
// //   <ul class="btn-wrapper">
// //     <li class="prev btn-item"><a class="btn-anchor" href="">前へ</a></li>
// //     <li class="next btn-item"><a class="btn-anchor" href="">次へ</a></li>
// //   </ul>
// // </div> -->


  <!-- .before('DOMの前')
  <ul class="lists">  .prepend('DOMの中の前')   jQuery    .append('DOMの中の後')    </ul>
  .after('DOMの後'); -->