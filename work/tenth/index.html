<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>

$(function() {
  var pages = 1;
  var lastpage = false;
  $('.search').after('<div class="message">'+'</div>');
  $(document).on('click','#js-search-button',function() {
    pages = 1;
    $('.lists').children().remove();
    fetch(); //（フェッチ）取得、読み込み
  });

  // pages=1はajaxのdateのpagesの変数
  // lastpage = false;はpagesがdata.pageCountと違う時
  // 18　div classsのsearchに（）のなかのdomをいれる
  // id　#js-search-button（検索ボタン）を押した時、pageを1ページを表示する。
  // $('.lists').children().remove();　.listsの子要素を削除する。
  // fetch();は、最後までの処理をもう一度行う。
// ーーーーーーーーーーーーーーーーーーーーーーajaxーーーーーーーーーーーーーーーーーーーーーーーーーーー
  function fetch() {
    var keyword = $('#js-search-word').val();
    $.ajax({
      url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',　//リクエストURL
      type: 'GET',　//HTTPのリクエストメソッド（POST/GET）を指定する
      datatype: 'json',　//JSONデータを受信する場合
      //json オブジェクト、配列、数値、文字列、真偽値、nullの(ソフトウェア内部で扱っているデータをそのまま、保存したり送受信することができるように変換すること)
      data: {
        applicationId: '1019399324990976605',　//アプリID
        booksGenreId: '001',　//楽天市場におけるジャンルを特定するためのID検索キーワード、ジャンルID、商品コード、ショップコードのいずれかが指定されていることが必須です。
        keyword: keyword,　// 検索のキーワードのこと
        hits: 20,　// 1ページあたりの取得件数
        page:pages　// page:2だと2ページを表示される
      },
    })
// ーーーーーーーーーーーーーーーーーーーーーーdoneーーーーーーーーーーーーーーーーーーーーーーーーー
  .done(function(data) {
    $('.message').empty();
    $('.js-pager').remove();
    if(data.count === 0) {
      $('.list').empty(); //<ul class="lists"></ul>子要素（var list）のこと
      $('.message').append('検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。');
    } else {
      $('.lists__item').remove();
      $(data.Items).each(function(index,value) {//index 数 value 内容
        var list = '<li class="lists__item">'+
                      '<div class="lists__item__inner">'+
                        '<a href='+value.Item.itemUrl+' class="lists__item__link" target="_blank">'+
                          '<img src='+value.Item.largeImageUrl+' class="lists__item__img" alt="">'+
                          '<p class="lists__item__detail">作品名：'+value.Item.title+'</p>'+
                          '<p class="lists__item__detail">作者：'+value.Item.author+'</p>'+
                          '<p class="lists__item__detail">出版社：'+value.Item.publisherName+'</p>'+
                        '</a>'+
                      '</div>'+
                    '</li>';
        $('.lists').append(list);
      });
      // console.log(data);
    };
// ーーーーーーーーーーーーーーーーーーーページャのテンプレートーーーーーーーーーーーーーーーーーーーーーーーーーー
    $('ul').after(
      '<div class="js-pager">'+
        '<ul class="btn-wrapper">'+
          '<li class="prev btn-item">'+'<a class="btn-anchor" href="#">前へ</a></li>'+
          '<li class="next btn-item">'+'<a class="btn-anchor" href="#">次へ</a></li>'+
        '</ul>'+
      '</div>');
      if (pages === data.pageCount) {
        $('.next').addClass('disabled');
        lastpage = true;
      } else {
        lastpage = false;
      }
      if (pages === 1) {
        $('.prev').addClass('disabled');
      }
    })
  // -------------------------------------fail---------------------------------------------
    .fail(function(error) {
      $('.message').empty();
        console.log(error);
      if(error.status === 400) {
        $('.message').append('検索文字が空、もしくは半角英数1文字になっています。');
      } else if (error.status === 0) {
        $('.message').append('通信に失敗しました。インターネットの接続をご確認ください。');
      } else if (error.status === 429) {
        $('.message').append('連打はやめましょう。');
      } else if (error.status === 500) {
        $('.message').append('システムエラー。長時間続くようであれば、こちらよりごお問い合わせください。');
      } else if (error.status === 503) {
        $('.message').append('メンテナンス (楽天API)');
      } else {
        $('.message').append('予期せぬエラーが発生しました。');
      }
    });
  }; // end totaldata
// -------------------------------------ページャクリックイベント---------------------------------------------
  $(document).on('click','.prev',function() {
    // console.log(lastpage);
    if(pages === 1){
      return false;
    } else {
      pages--;
      fetch();
    }
  });
  $(document).on('click','.next',function() {
    // console.log(lastpage);
    if (lastpage) {
      $('.message').empty();
      $('.message').append('これ以上ありません。');
    } else {
      pages++;
      fetch();
    }
  });
});
// ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
    </script>
  </body>
</html>
<!-- // 楽天ブックスの総合検索APIを使って製作してください。
// // answerの挙動を良く見てね！
// //
// // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
// // https://webservice.rakuten.co.jp/api/bookstotalsearch/
// //
// //
// // [使うメソッド]
// // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
// // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
// // 以下は今回使う$.ajaxの基本的な形です。
// //
// // $.ajax({
// //   url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
// //   type: 'GET',
// //   datatype: 'json',
// //   data: {
// //     // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
// //     applicationId: '1019399324990976605', // (今回はこのIDを使用してください) ※IDは他サイト等には絶対に転載しないでください
// //     booksGenreId: '001'
// //   },
// // }).done(function(data) {
// //   // この中にデータ取得後の動きを記述していきます。
// // });
// //
// //
// // $.ajaxによってデータが取得できたら、必要なデータ(作品名とか作者名とか)を取得します。
// // 取得できたらHTMLに<ul class='lists'></ul>を用意しているので、下のテンプレに沿ってデータを入れ込みましょう。
// // <li class='lists__item'>
// //  <div class='lists__item__inner'>
// //    <a href='' class='lists__item__link' target='_blank'>
// //      <img src='' class='lists__item__img' alt=''>
// //      <p class='lists__item__detail'>作品名：</p>
// //      <p class='lists__item__detail'>作者　：</p>
// //      <p class='lists__item__detail'>出版社：</p>
// //    </a>
// //  </div>
// // </li>
// //
// // 取得できた書籍の件数をもとに、ページャを作成しましょう
// // ページャの条件
// // ├ 「前へ」と「次へ」のボタンがある
// // ├ 1ページ目では「前へ」に、最後のページでは「次へ」にdisabledクラスをつけて非活性（使用不能）にする
// // └ 1ページしかない場合はどちらもdisabledクラスをつけて非活性にする
// //
// // ページャのテンプレート
// // <div class="js-pager">
// //   <ul class="btn-wrapper">
// //     <li class="prev btn-item"><a class="btn-anchor" href="">前へ</a></li>
// //     <li class="next btn-item"><a class="btn-anchor" href="">次へ</a></li>
// //   </ul>
// // </div> -->


  <!-- .before('DOMの前')
  <ul class="lists">  .prepend('DOMの中の前')   jQuery    .append('DOMの中の後')    </ul>
  .after('DOMの後'); -->